import { useEffect, useState } from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import Home from "./pages/Home";
import Main from "./pages/Main";
import "./App.css";
import CloudBackground from "./Components/CloudBackground";


type Cloud = {
  id: string;
  x: number;
  y: number;
  size: number;
  rotate: number;
  opacity: number;
};

function uid() {
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

export default function App() {
  const [clouds, setClouds] = useState<Cloud[]>([]);

  function clearClouds() {
  setClouds([]);
}

  function onShellClick(e: React.MouseEvent<HTMLDivElement>) {
    const target = e.target as HTMLElement;

    // ✅ Don't spawn when clicking on real UI
    if (target.closest("button, a, input, textarea, select, [data-no-spawn='true']")) return;

    const shell = e.currentTarget;
    const rect = shell.getBoundingClientRect();

    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    console.log("CLICK", e.clientX, e.clientY);


    setClouds((prev) => [
      ...prev,
      {
        id: uid(),
        x,
        y,
        size: 30 + Math.random() * 60,
        rotate: Math.random() * 360,
        opacity: 0.7 + Math.random() * 0.3,
      },
    ]);
  }

  // because you have nodeIntegration: true
async function sendResize(dx: number, dy: number) {
  const electron = await import("electron");
  electron.ipcRenderer.send("resize-window", dx, dy);
}


useEffect(() => {
  let startX = 0;
  let startY = 0;
  let mode: "right" | "bottom" | "corner" | null = null;

  const onMouseMove = (e: MouseEvent) => {
    if (!mode) return;

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    if (mode === "right") sendResize(dx, 0);
    if (mode === "bottom") sendResize(0, dy);
    if (mode === "corner") sendResize(dx, dy);

    startX = e.clientX;
    startY = e.clientY;
  };

  const stopResize = () => {
    mode = null;
    window.removeEventListener("mousemove", onMouseMove);
    window.removeEventListener("mouseup", stopResize);
  };

  const onRightMouseDown = (e: MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    mode = "right";
    startX = e.clientX;
    startY = e.clientY;
    window.addEventListener("mousemove", onMouseMove);
    window.addEventListener("mouseup", stopResize);
  };

  const onBottomMouseDown = (e: MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    mode = "bottom";
    startX = e.clientX;
    startY = e.clientY;
    window.addEventListener("mousemove", onMouseMove);
    window.addEventListener("mouseup", stopResize);
  };

  const onCornerMouseDown = (e: MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    mode = "corner";
    startX = e.clientX;
    startY = e.clientY;
    window.addEventListener("mousemove", onMouseMove);
    window.addEventListener("mouseup", stopResize);
  };

  const right = document.querySelector(".resize-right") as HTMLElement | null;
  const bottom = document.querySelector(".resize-bottom") as HTMLElement | null;
  const corner = document.querySelector(".resize-grip") as HTMLElement | null;

  // ✅ IMPORTANT: cast handler to EventListener to satisfy TS
  right?.addEventListener("mousedown", onRightMouseDown as unknown as EventListener);
  bottom?.addEventListener("mousedown", onBottomMouseDown as unknown as EventListener);
  corner?.addEventListener("mousedown", onCornerMouseDown as unknown as EventListener);

  return () => {
    right?.removeEventListener("mousedown", onRightMouseDown as unknown as EventListener);
    bottom?.removeEventListener("mousedown", onBottomMouseDown as unknown as EventListener);
    corner?.removeEventListener("mousedown", onCornerMouseDown as unknown as EventListener);
    stopResize();
  };
}, []);



    return (
    <div className="appShell" onClick={onShellClick}>
      <CloudBackground clouds={clouds} />

      <div className="appContent">
        <Routes>
          <Route path="/" element={<Home onClearClouds={clearClouds} />} />
          <Route path="/main" element={<Main />} />
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </div>

      <div className="resize-right" />
      <div className="resize-bottom" />
      <div className="resize-grip" />
    </div>
  );

}